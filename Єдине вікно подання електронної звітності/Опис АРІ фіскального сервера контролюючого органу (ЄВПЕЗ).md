Опис АРІ фіскального сервера (Єдине вікно подання електронної звітності)

Зміст

[Загальні положення](#_Toc45394870)

[Поняття і визначення](#_Toc45394871)

[Порядок локальної нумерації документів](#_Toc45394872)

[Порядок фіскальної нумерації онлайн документів](#_Toc45394873)

[Загальний порядок взаємодії ПРРО з Фіскальним Сервером](#_Toc45394874)

[Відкриття зміни](#_Toc45394875)

[Реєстрація фіскального касового чека](#_Toc45394876)

[Реєстрація Z-звіту і закриття зміни](#_Toc45394877)

[Офлайн сесія](#_Toc45394878)

[Режими онлайн і офлайн](#_Toc45394879)

[Пакет офлайн документів](#пакет-офлайн-документів)

[Відкликання останнього онлайн чека](#_Toc45394881)

[Сторнування останнього чека](#сторнування-останнього-чека)

[Структура фіскального номера офлайн документа](#_Toc45394883)

[Розрахунок контрольного числа](#_Toc45394884)

[Розрахунок гешу офлайн документа](#_Toc45394885)

[Блокування роботи ПРРО](#блокування-роботи-прро)

[Формування Діапазону та облік фіскальних
номерів](#формування-діапазону-та-облік-фіскальних-номерів)

[Сценарії роботи](#_Toc45394888)

[1. Новий екземпляр ПРРО](#_Toc45394889)

[2. ПРРО працює з відкритою зміною (сервер недоступний)](#_Toc45394890)

[3. ПРРО працює з закритою зміною (сервер недоступний)](#_Toc45394891)

[4. Перевірка зв’язку з сервером (ПРРО знаходиться в режимі
онлайн)](#перевірка-звязку-з-сервером-прро-знаходиться-в-режимі-онлайн)

[5. Перевірка зв’язку з сервером (ПРРО знаходиться в режимі
офлайн)](#_Toc45394893)

[6. Скасування реєстрації ПРРО](#скасування-реєстрації-прро)

[Зауваження щодо реалізації](#_Toc45394895)

[Класи документів](#_Toc45394896)

[Чек. Типи документів](#_Toc45394897)

[Чек. Розширені типи документів](#_Toc45394898)

[Коди помилок](#_Toc45394899)

[Команди](#_Toc45394900)

[Запит стану сервера](#_Toc45394901)

[Запит доступних об'єктів](#_Toc45394902)

[Запит стану ПРРО](#_Toc45394903)

[Запит чека](#_Toc45394904)

[Запит Z-звіта](#_Toc45394905)

[Запит переліку змін за період](#_Toc45394906)

[Запит переліку документів зміни](#_Toc45394907)

[Запит підсумків останньої зміни](#_Toc45394908)

[Запит відомостей про документ за локальним номером](#_Toc45394909)

[Видаткові чеки (повернення)](#_Toc45394910)

[Сторнування попереднього чека](#_Toc45394911)

[Порядок засвідчення повідомлень кваліфікованим електронним
підписом](#_Toc45394912)

[Адреса фіскального сервера](#_Toc45394913)

# Загальні положення

Фіскальний сервер контролюючого органу, через який реалізується фіскальна
функція програмних реєстраторів розрахункових операцій, забезпечує:

-   Одержання документів (чеків, Z-звітів, повідомлень тощо) від програмних
    реєстраторів розрахункових операцій;

-   Перевірку коректності структури і складу одержаних документів;

-   Призначення документам фіскальних номерів;

-   Надсилання відправнику документа відповіді, що містить результат обробки
    документа і призначений документу фіскальний номер;

-   Зберігання документів для подальшого використання в інформаційно-аналітичних
    системах;

-   Обробку запитів щодо надання документів (чеків покупцям, даних розрахункових
    операцій для формування ПРРО, Z-звітів, тощо).

-   Збереження сертифікатів електронних підписів та/або печаток, що
    використовуються ПРРО;

-   Збереження даних про зареєстровані ПРРО та господарські одиниці, на яких
    ПРРО застосовується (реєстр ПРРО).

Реєстрація документів (чеків, Z-звітів, повідомлень, тощо) здійснюється:

-   в режимі оперативного («онлайн») надсилання документів на фіскальний сервер;

-   в режимі відкладеного («офлайн») надсилання документів на фіскальний сервер.

Документи в системі засвідчуються кваліфікованим електронним підписом (КЕП)
фізичної особи або електронною печаткою суб’єкта господарювання, на якого
зареєстровано ПРРО.

На документи фіскальним сервером накладаються електронні позначки часу від
будь-якого надавача електронних довірчих послуг. У разі якщо зв'язок з службами
позначки часу відсутній взагалі, проставляється дата проведення розрахункової
операції, що відповідає поточній системній даті.

# Поняття і визначення

**ПРРО** – Програмний реєстратор розрахункових операцій. Система виписки
електронних касових чеків, що використовується продавцем.

**Сервер** – Фіскальний Сервер реєстрації розрахункових операцій.

**Локальний номер чека** – Номер, призначений чеку системою продавця.

**Фіскальний номер чека** – Номер, призначений чеку сервером.

**Офлайн сесія** – Сукупність документів, створених в режимі офлайн, між
припиненням і відновленням зв’язку ПРРО з сервером.

# Порядок локальної нумерації документів

Локальна нумерація документів ведеться окремо кожним ПРРО. Нумерація
здійснюється в межах:

-   юридичної/фізичної особи продавця;

-   господарської одиниці;

-   фіскального номера ПРРО.

Локальна нумерація документів ведеться наскрізь, незалежно від класу документа
(чек, Z-звіт).

# Порядок фіскальної нумерації онлайн документів

Фіскальна нумерація документів ведеться сервером.

Фіскальна нумерація документів ведеться наскрізь, незалежно від джерела і класу
документа.

# Загальний порядок взаємодії ПРРО з Фіскальним Сервером

1.  Відкриття зміни;

2.  Реєстрація фіскальних касових чеків;

3.  Реєстрація Z-звіту і закриття зміни.

## Відкриття зміни

1.  ПРРО створює XML документ повідомлення із призначеним локальним номером і
    типом «Відкриття зміни», засвідчує його кваліфікованим електронним підписом
    продавця і надсилає на сервер. Відкриття кожної наступної зміни відбувається
    за умови закриття попередньої зміни (формування Z-звіту).

2.  Сервер здійснює необхідні перевірки.

3.  У разі помилки, сервер надсилає у відповідь XMLквитанції.

4.  У разі успішної обробки, сервер реєструє документ шляхом присвоєння йому
    номера, який є номером зміни, зберігає документ в БД і надсилає у відповідь
    XMLквитанції щодо успішної реєстрації документа.

5.  Сервер встановлює для ПРРО стан «зміну відкрито».

## Реєстрація фіскального касового чека

1.  ПРРО створює XMLдокумент чека із призначеним локальним номером, засвідчує
    його КЕП продавця і надсилає на сервер.

2.  Сервер здійснює необхідні перевірки.

3.  У разі помилки, сервер надсилає у відповідь XMLквитанції.

4.  У разі успішної обробки, сервер зберігає документ в БД, призначає документу
    фіскальний номер і надсилає у відповідь XMLквитанції щодо успішної
    реєстрації документа, що містить фіскальний номер.

## Реєстрація Z-звіту і закриття зміни

1.  Сервер формує проект Z-звіту за запитом ПРРО на дату та час отримання запиту
    та надсилає його до ПРРО. Отриманий проект Z-звіту має бути перевірений,
    може бути змінений. Кількість запитів для формування проекту Z-звіту
    необмежена.

2.  ПРРО (самостійно або на основі проекту, отриманого від фіскального сервера)
    створює XMLдокумент Z-звіту із призначеним локальним номером, засвідчує його
    КЕП продавця і надсилає на сервер.

3.  Сервер здійснює необхідні перевірки.

4.  У разі помилки, сервер надсилає у відповідь XMLквитанції.

5.  У разі успішної обробки, сервер зберігає документ в БД, і надсилає у
    відповідь XMLквитанції щодо успішної реєстрації документа.

6.  ПРРО надсилає на сервер повідомлення (технічний документ) із типом «Закриття
    зміни», на підставі якого відбувається закриття зміни.

7.  Сервер встановлює для ПРРО стан «зміну закрито».

# Офлайн сесія

Для обробки чеків в режимі офлайн, використовується поняття **«Офлайн сесія»**.

Офлайн сесія обмежена документами «Початок офлайн режиму (сесії)» і «Завершення
офлайн режиму (сесії)».

Проміжок часу між першим і останнім документом (тобто між документами «Початок
офлайн сесії» і «Завершення офлайн режиму (сесії)») у межах однієї офлайн сесії
не може перевищувати встановлене законодавством значення (36 годин за сесію, 168
годин за місяць). (В програмних РРО рекомендується реалізувати можливість
інформування користувача про сплив одного з термінів, дозволених для роботи ПРРО
в режимі офлайн).

Кількість документів у межах одної офлайн сесії не може перевищувати надану
кількість номерів (стандартно 2000, за окремим запитом суб’єкта кількість може
бути збільшена).

Офлайн сесія має унікальний номер (число). Номер офлайн сесії надається сервером
у відповідь на документ «Відкриття зміни».

Коли сервер знову стає доступний, ПРРО надсилає пакет, що містить документи:
«Початок офлайн режиму (сесії)», чеки, Z-звіти, «Завершення офлайн режиму
(сесії)». У відповідь сервер надсилає номер наступної офлайн сесії. (Поповнює
фіскальні номери із Діапазону до 2000, або до більшої кількості, що використана
ПРРО із збільшеним діапазоном).

Офлайн сессія застосовується тільки з ПРРО, для якого виданий номер офлайн сесії
та фіскальні номери із Діапазону. З іншим ПРРО офлайн сесія не може бути
застосована.

В межах офлайн сесії може бути відкрито і закрито необмежену кількість змін
(якщо зміни не відкриті одночасно і кожному відкриттю нової зміни передує
закриття попередньої). Для закриття зміни формується Z-звіт і повідомлення
(технічний документ) із типом «Закриття зміни».

## Режими онлайн і офлайн

ПРРО знаходиться в режимі онлайн, якщо на ньому не створений документ «Початок
офлайн сесії».

ПРРО знаходиться в режимі офлайн, якщо на ньому створений документ «Початок
офлайн режиму (сесії)», що не надісланий на сервер, і для якого відсутній
документ «Завершення офлайн режиму (сесії)».

## Пакет офлайн документів

Коли сервер стає доступний, ПРРО надсилає один (або декілька) пакетів, що
містить документи: «Початок офлайн режиму (сесії)», чеки, Z-звіти, «Завершення
офлайн режиму (сесії)».

Структура пакету:

\<Розмір документа 1 (4 байта))\>\<Документ 1\>\<Розмір документа 2 (4
байта)\>\<Документ 2\>…\<Розмір документаN (4 байта)\>\<Документ N\>

Кожен документ в пакеті повинен бути засвідчений КЕП.

Весь пакет також засвідчується КЕП відправника.

Максимальна кількість документів в пакеті обмежена (100).

Якщо кількість створених офлайн документів перевищує максимальну, надсилаються
декілька пакетів. Пакети надсилаються по черзі, тобто кожний наступний пакет
надсилається після одержання від сервера позитивної відповіді щодо одержання
попереднього пакета.

Сервер надсилає номер наступної офлайн сесії у відповідь на пакет, який містить
документ «Завершення офлайн режиму (сесії)» та поповнює діапазон використаних
номерів.

Формат JSONвідповіді:

{

OfflineSessionId = \<Ідентифікатор офлайн сесії\>,

OfflineSeed = \<"Секретне число" для обчислення фіскального номера офлайн
документа\>

}

Якщо пакет не містить документ «Завершення офлайн режиму (сесії)», сервер
надсилає у відповідь “OK”.

### Відкликання останнього онлайн чека

Якщо перехід в режим офлайн було здійснено внаслідок розірвання зв’язку з
сервером під час реєстрації чека, але сервер отримав документ і здійснив
реєстрацію чека з призначенням фіскального номера, і чек було переформовано в
режимі офлайн із присвоєнням номера із діапазону, виникає дублювання онлайн і
офлайн чеків.

Для усунення такого дублювання:

-   ПРРО зберігає чек, який надіслано до сервера, але фіскальний номер не
    отриманий внаслідок розірвання зв’язку;

-   Після відновлення зв’язку, ПРРО одержує з сервера останній зареєстрований
    чек;

-   Якщо останній зареєстрований чек дорівнює збереженому, в документі «Початок
    офлайн режиму (сесії)» додається елемент
    \<REVOKELASTONLINEDOC\>true\</REVOKELASTONLINEDOC\>.

### Сторнування останнього чека

Якщо покупець відмовляється від проведеної операції з торгівлі валютними
цінностями і при цьому здійснено реєстрацію чека фіскальним сервером, або якщо
чек з помилковою сумою зареєстрований фіскальним сервером:

-   ПРРО надсилає на фіскальний сервер фіскальний чек типу «Чек сторнування
    попереднього чека» із присвоєним сервером фіскальним номером, що підлягає
    сторнуванню, чек має відповідну ознаку «сторно» (елемент \<ORDERSTORNUM \>
    Фіскальний номер чека, для якого здійснюється сторнування
    \</ORDERSTORNUM\>).

-   Фіскальний сервер перевіряє фіскальний номер проведеної розрахункової
    операції, реєструє операцію «сторно» із нульовим значенням сторнованої суми,
    присвоює фіскальний номер чеку з ознакою «сторно» та направляє користувачу.

## Структура фіскального номера офлайн документа

Фіскальний номер документа, що виданий офлайн, має таку структуру:

\<Номер офлайн сесії\>.\<Локальний номер документа в офлайн сесії\>.\<Контрольне
число\>

Локальний номер документа в офлайн сесії починається з 1 і збільшується
послідовно.

*Зауваження:* Принцип безперервної локальної нумерації документів залишається
незмінним. Тобто, поле «Локальний номер документа» продовжує безперервне
збільшення значень, незалежно від режиму (онлайн чи офлайн). Значення поля
«Локальний номер документа» не дорівнює значенню «Локальний номер документа в
офлайн сесії».

Приклад фіскального номера офлайн документа: “82563.25.6127”

(при цьому «Локальний номер документа» може дорівнювати “9537”)

## Розрахунок контрольного числа

Одночасно з передачею номера офлайн сесії, сервер надає ПРРО «секретне число».

Для розрахунку контрольного числа, ПРРО створює текстову строку, що містить
об’єднання значень, розділених символом «,»:

-   «Секретне число»

-   Дата документа (ДДММРР)

-   Час документа (ГГХХСС)

-   Локальний номер документа

-   Фіскальний номер реєстратора

-   Локальний номер реєстратора

-   Загальна сума оплати по документу класу «Чек» (формат «0.00») (якщо елемент
    присутній)

-   Геш попереднього документа (крім першого документа, створеного в межах
    офлайн сесії)

Від строки розраховується геш за алгоритмом CRC32. Із розрахованого гешу
беруться 4 молодші розряди.

Контрольне число не може дорівнювати 0. Якщо у результаті розрахунку
контрольного числа одержано 0, призначається значення 1.

## Розрахунок гешу офлайн документа

Геш офлайн документа розраховується за алгоритмом геш-функції, що оприлюднена на
сайті ДПС, від попереднього документа поточної офлайн сесії, і зберігається в
елементі “DOCKHASH”.Наприклад,
\<DOCKHASH\>68f2e680d84e900a4279fb3b614d86138f1a9f6c67df0510fe837c75ec7cf0ec\</DOCKHASH\>.

Для першого документа офлайн сесії елемент “DOCKHASH” не створюється.

## Блокування роботи ПРРО

Сервер блокує роботу ПРРО у разі:

перевищення допустимого терміну роботи в офлайн режимі «36 годин» або «168
годин» протягом календарного місяця та надсилає повідомлення користувачеві.
Розблоковує роботу ПРРО після настання нового часового періоду з якого
починається відлік дозволеного часу роботи в режимі офлайн.

Наявності повідомлення за формою 2-ПРРО з позначкою «несправність»

## Формування Діапазону та облік фіскальних номерів

Сервер формує діапазон фіскальних номерів для кожного ПРРО, який видається ПРРО
під час присвоєння ПРРО фіскального номера (2000 або більше);

Сервер поповнює діапазон номерів до 2000 для ПРРО після отримання чеків,
Z-звітів, повідомлень із присвоєними номерами із Діапазону;

Сервер веде облік виданих Діапазонів, присвоює статус кожному номеру:

Зарезервований – після видачі номера користувачеві до моменту прийняття сервером
документів від ПРРО;

Використаний – після прийняття документів, яким присвоєні номери із Діапазону.

# Сценарії роботи

## Новий екземпляр ПРРО

1.  Користувач заходить в ПРРО з аутентифікацією по КЕП. ПРРО одержує з сервера
    довідники (перелік господарських одиниць (ГО), перелік фіскальних номерів
    ПРРО, перші 2000 фіскальних номерів для присвоєння розрахунковим документам
    ПРРО, що працює в режимі офлайн тощо).

    1.  Користувач вибирає доступну ГО і фіскальний номер ПРРО, і дає команду на
        відкриття зміни. ПРРО надсилає на сервер документ «Відкриття зміни», і
        одержує у відповідь фіскальний номер документа, номер офлайн сесії і
        «секретне число».

    2.  Користувач видає чеки.

## ПРРО працює з відкритою зміною (сервер недоступний)

1.  Користувач заходить в ПРРО з аутентифікацією по КЕП.

    1.  Користувач заходить в ГО і фіскальний номер ПРРО, для якого відкрито
        офлайн сесію.

    2.  ПРРО перевіряє, чи зміну відкрито тим самим користувачем. Якщо ні –
        робота Користувача неможлива до закриття зміни.

    3.  Користувач видає чеки.

## ПРРО працює з закритою зміною (сервер недоступний)

1.  Користувач заходить в ПРРО з аутентифікацією по КЕП.

    1.  Користувач заходить в доступну ГО і фіскальний номер ПРРО, для якого
        відкрито офлайн сесію, і дає команду на відкриття зміни.

    2.  Користувач видає чеки.

    3.  Користувач закриває зміну.

## Перевірка зв’язку з сервером (ПРРО знаходиться в режимі онлайн)

1.  Якщо при передачі документа сервер недоступний, ПРРО запитує у користувача
    підтвердження переходу в режим офлайн.

    1.  Якщо користувач згодний, ПРРО створює документ «Початок офлайн режиму
        (сесії)»

## Перевірка зв’язку з сервером (ПРРО знаходиться в режимі офлайн)

1.  ПРРО періодично перевіряє зв’язок з сервером (наприклад, за допомогою
    команди «Запит стану ПРРО», або команди «Запит стану сервера»).

    1.  Якщо зв’язок присутній, ПРРО автоматично переходить в режим онлайн, про
        що інформує користувача.

    2.  ПРРО надсилає на сервер пакет, що містить документи, створені в режимі
        офлайн.

    3.  У разі відмови сервера на підставі некоректного сертифікату, пакет
        засвідчується підписом старшого користувача або керівника.

    4.  Якщо пакет успішно прийнятий, ПРРО отримує підтвердження (квитанцію) від
        фіскального сервера.

## Скасування реєстрації ПРРО

1.  Користувач надсилає заяву з позначкою «Скасування реєстрації»

    1.  Користувач надсилає повідомлення з позначкою «несправність» або
        «крадіжка пристрою»

    2.  Автоматичне скасування (припинено державну реєстрацію, закрито
        господарську одиницю, тощо).

# Зауваження щодо реалізації

1.  Кодування текстових полів документів XML: Windows-1251.

2.  Тип HTTP-запиту – POST.

3.  Заголовок “Content-Type”: “application/octet-stream”.

4.  Використання компресії Gnu Zip (GZip) або Zip (deflate). Вхідні та вихідні
    документи оброблюються алгоритмом GZip або Zip для зменшення розміру
    повідомлення.

5.  У разі використання компресії, заголовок “Content-Encoding” вхідного
    повідомлення повинен мати значення “gzip” або “deflate”.

6.  Повідомлення містить XML документ, засвідчений КЕП відправника.

7.  Вхідне повідомлення може містити серйозні помилки, що не дозволяють його
    подальшу обробку. Наприклад, повідомлення не являє собою підписаний блок або
    містить більше ніж одну КЕП. У випадку грубого порушення вимог до формату
    вхідного повідомлення, у відповідь надсилається код статусу обробки HTTP 4xx
    “Client Error”. У тілі відповіді надається інформація щодо причини помилки.
    Наприклад, “Content-Type must be 'application/octet-stream'”, “Message not
    contains signed data” і таке інше.

8.  Сервер оброблює Url:

    -   “\<адреса\>/doc“ – одержання документів (чеків, Z-звітів тощо)

    -   “\<адреса\>/pck“ – одержання пакетів документів (офлайн документи тощо)

    -   “\<адреса\>/cmd“ – одержання команд

9.  Команди надсилаються у форматі JSON. Див. розділ «Команди».

## Класи документів

/// \<summary\>

/// Клас документа

/// \</summary\>

public enum DocumentClass {

/// \<summary\>

/// Чек

/// \</summary\>

**Check** = 0,

/// \<summary\>

/// Z-звіт

/// \</summary\>

**ZRep** = 1

}

## Чек. Типи документів

/// \<summary\>

/// Чек. Тип документа

/// \</summary\>

public enum CheckDocumentType {

/// \<summary\>

/// Чек реалізації товарів/послуг

/// \</summary\>

**SaleGoods** = 0,

/// \<summary\>

/// Чек переказу коштів

/// \</summary\>

**TransferFunds** = 1,

/// \<summary\>

/// Чек операції обміну валюти

/// \</summary\>

**CurrencyExchange** = 2,

/// \<summary\>

/// Чек видачі готівки

/// \</summary\>

**CashWithdrawal** = 3,

/// \<summary\>

/// Відкриття зміни

/// \</summary\>

**OpenShift** = 100,

/// \<summary\>

/// Закриття зміни

/// \</summary\>

**CloseShift** = 101,

/// \<summary\>

/// Початок офлайн сесії

/// \</summary\>

**OfflineBegin** = 102,

/// \<summary\>

/// Завершення офлайн сесії

/// \</summary\>

**OfflineEnd** = 103

}

## Чек. Розширені типи документів

/// \<summary\>

/// Чек. Розширений тип документа

/// \</summary\>

public enum CheckDocumentSubType {

/// \<summary\>

/// Касовий чек (реалізація)

/// \</summary\>

**CheckGoods** = 0,

/// \<summary\>

/// Видатковий чек (повернення)

/// \</summary\>

**CheckReturn** = 1,

/// \<summary\>

/// Чек операції «службове внесення»/«отримання авансу»

/// \</summary\>

**ServiceDeposit** = 2,

/// \<summary\>

/// Чек операції «отримання підкріплення»

/// \</summary\>

**AdditionalDeposit** = 3,

/// \<summary\>

/// Чек операції «службова видача»/«інкасація»

/// \</summary\>

**ServiceIssue** = 4,

/// \<summary\>

/// Чек сторнування попереднього чека

/// \</summary\>

**CheckStorno** = 5

}

## Коди помилок

/// \<summary\>

/// Коди помилок

/// \</summary\>

public enum ErrorCode {

/// \<summary\>

/// OK

/// \</summary\>

**Ok** = 0,

/// \<summary\>

/// ПРРО не зареєстрований

/// \</summary\>

**TransactionsRegistrarAbsent** = 1,

/// \<summary\>

/// Відсутній доступ до ПРРО для користувача

/// \</summary\>

**OperatorAccessToTransactionsRegistrarNotGranted** = 2,

/// \<summary\>

/// В документі зазначено реєстраційний код платника, що не дорівнює
реєстраційному коду господарської одиниці

/// \</summary\>

**InvalidTin** = 3,

/// \<summary\>

/// Зміну для ПРРО наразі відкрито

/// \</summary\>

**ShiftAlreadyOpened** = 4,

/// \<summary\>

/// Зміну для ПРРО наразі не відкрито

/// \</summary\>

**ShiftNotOpened** = 5,

/// \<summary\>

/// Останній документ, зареєстрований перед закриттям зміни, повинен бути
Z-звітом

/// \</summary\>

**LastDocumentMustBeZRep** = 6,

/// \<summary\>

/// Некоректний локальний номер чека

/// \</summary\>

**CheckLocalNumberInvalid** = 7,

/// \<summary\>

/// Z-звіт наразі зареєстрований для поточної зміни

/// \</summary\>

**ZRepAlreadyRegistered** = 8,

/// \<summary\>

/// Помилка валідації документа

/// \</summary\>

**DocumentValidationError** = 9,

/// \<summary\>

/// Помилка валідації пакету офлайн документів

/// \</summary\>

**PackageValidationError** = 10,

/// \<summary\>

/// Некоректний параметр запиту

/// \</summary\>

**InvalidQueryParameter** = 11,

/// \<summary\>

/// Помилка криптографічних функцій

/// \</summary\>

**CryptographyError** = 12

}

## Команди

### Запит стану сервера

Запит повинен містити JSON.

Формат JSON запиту:

{

“Command”**:** “ServerState”

}

Формат JSON відповіді:

{

Timestamp = \<Дата і час відповіді сервера\>

}

Дата і час представлені текстом у форматі ISO 8601 (наприклад,
"2018-10-17T01:23:00+03:00" ).

### Запит доступних об'єктів

Запит повинен містити JSON, підписаний КЕП користувача.

Формат JSON запиту:

{

“Command”**:** “**Objects**”

}

У відповідь повертається перелік доступних користувачу господарських одиниць і
ПРРО.

Формат JSON відповіді:

internal class ResponseObjects {

public TaxObjectItem[] TaxObjects { get; set; }

}

public class TaxObjectItem {

public string Address { get; set; }

public string Guid { get; set; }

public string Name { get; set; }

public long Tin { get; set; }

public long Ipn { get; set; }

public TransactionsRegistrarItem[] TransactionsRegistrars { get; set; }

}

public class TransactionsRegistrarItem {

public long NumFiscal { get; set; }

public int NumLocal { get; set; }

}

У разі відсутності даних, повертається код HTTP 204 “No Content”.

### Запит стану ПРРО

Запит повинен містити JSON, підписаний КЕП користувача.

Формат JSON запиту:

{

“Command”**:** “TransactionsRegistrarState”**,**

“NumFiscal”**:** “\<Фіскальний номер ПРРО\>”**,**

“OfflineSessionId”**:** “\<Ідентифікатор офлайн сесії, для якої будуть надіслані
пакети документів (не обов’язковий)\>”**,**

“OfflineSeed”**:** \<"Секретне число" для обчислення фіскального номера офлайн
документа офлайн сесії, для якої будуть надіслані пакети документів (не
обов’язковий)\>”

}

Формат JSON відповіді:

{

ShiftState = \<0-зміну не відкрито, 1-зміну відкрито\>,

ShiftId = \<Ідентифікатор зміни\>,

OpenShiftFiscalNum = \<Фіскальний номер документа “Відкриття зміни”\>,

ZRepPresent = \<Ознака присутності Z-звіту (false/true)\>,

Name = \<П.І.Б. оператора, що відкрив зміну\>,

SubjectKeyId = \<Ідентифікатор ключа суб’єкта сертифікату оператора, що відкрив
зміну\>,

FirstLocalNum = \<Перший внутрішній номер документа у зміні\>,

NextLocalNum = \<Наступний внутрішній номер документа\>,

LastFiscalNum = \<Останній фіскальний номер документа\>,

OfflineSupported = \<Для ПРРО може використовуватись режим офлайн\>,

ChiefCashier = \<Користувач є старшим касиром\>,

OfflineSessionId = \<Ідентифікатор офлайн сесії (null – режим офлайн заборонений
для ПРРО)\>,

OfflineSeed = \<"Секретне число" для обчислення фіскального номера офлайн
документа (null – режим офлайн заборонений для ПРРО)\>,

OfflineNextLocalNum = \<Наступний локальний номер документа в офлайн сесії (null
– режим офлайн заборонений для ПРРО)\>,

OfflineSessionDuration = \<Тривалість офлайн сесії (хвилин)\>,

OfflineSessionsMonthlyDuration = \<Сумарна тривалість офлайн сесій за поточний
місяць (хвилин)\>

}

У разі відсутності даних, повертається код HTTP 204 “No Content”.

Поля “Offline…” заповнюються, якщо запит засвідчено КЕП особи, яка відкрила
зміну, або КЕП старшого користувача або керівника.

### Запит чека

Запит повинен містити JSON.

Формат JSON запиту:

{

“Command”**:** “**Check**”**,**

“RegistrarNumFiscal”**:** “\<Фіскальний номер ПРРО\>”**,**

“NumFiscal”**:** “\<Фіскальний номер чека\>”

}

У відповідь надається XML документ чека, засвідчений КЕП сервера.

У разі відсутності даних, повертається код HTTP 204 “No Content”.

### Запит Z-звіта

Запит повинен містити JSON, підписаний КЕП користувача.

Формат JSON запиту:

{

“Command”**:** “**ZRep**”**,**

“RegistrarNumFiscal”**:** “\<Фіскальний номер ПРРО\>”**,**

“NumFiscal”**:** “\<Фіскальний номер Z-звіту\>”

}

У відповідь надається XML документ Z-звіту, засвідчений КЕП сервера.

У разі відсутності даних, повертається код HTTP 204 “No Content”.

### Запит переліку змін за період

Запит повинен містити JSON, підписаний КЕП користувача.

Формат JSON запиту:

{

“Command”**:** “**Shifts**”**,**

“NumFiscal”**:** “\<Фіскальний номер ПРРО\>”,

“From”**:** “\<Дата і час початку періоду\>”,

“To”**:** “\<Дата і час завершення періоду\>”

}

Дата і час представлені текстом у форматі ISO 8601 (наприклад,
"2018-10-17T01:23:00+03:00" ) або JavaScript (наприклад,
"/Date(1539723599000)/").

Формат JSON відповіді:

{

Shifts:

[{

ShiftId = \<Ідентифікатор зміни\>,

OpenShiftFiscalNum = \<Фіскальний номер документа “Відкриття зміни”\>,

Opened = \<Дата і час відкриття зміни\>,

OpenName = \<П.І.Б. оператора, що відкрив зміну\>,

OpenSubjectKeyId = \<Ідентифікатор ключа суб’єкта сертифікату оператора\>,

Closed = \<Дата і час закриття зміни\>,

CloseName = \<П.І.Б. оператора, що закрив зміну\>,

CloseSubjectKeyId = \<Ідентифікатор ключа суб’єкта сертифікату оператора\>

}]

}

### Запит переліку документів зміни

Запит повинен містити JSON, підписаний КЕП користувача.

Формат JSON запиту:

{

“Command”**:** “**Documents**”**,**

“NumFiscal”**:** “\<Фіскальний номер ПРРО\>”,

“ShiftId”**:** “\<Ідентифікатор зміни\>”,

“OpenShiftFiscalNum”**:** “\<Фіскальний номер документа “Відкриття зміни”\>”

}

Повинно бути заповненим або поле “ShiftId”, або поле “OpenShiftFiscalNum”.

Формат JSON відповіді:

{

Documents:

[{

NumFiscal = \<Фіскальний номер документа\>,

NumLocal = \<Локальний номер документа\>,

DocClass = \<Клас документа (“**Check**”, “**ZRep**”)\>,

CheckDocType = \<Тип чека (“**SaleGoods**”, …)\>,

Revoked = \<Ознака відкликаного документа\>,

Storned = \<Ознака сторнованого документа\>

}]

}

### Запит підсумків останньої зміни

Запит повинен містити JSON, підписаний КЕП користувача.

Формат JSON запиту:

{

“Command”**:** “LastShiftTotals”**,**

“NumFiscal”**:** “\<Фіскальний номер ПРРО\>”

}

Формат JSON відповіді:

{

ShiftState = \<0-зміну не відкрито, 1-зміну відкрито\>,

ZRepPresent = \<Ознака присутності Z-звіту (false/true)\>,

Totals = \<Підсумки зміни (якщо зміну відкрито)\>

}

У разі відсутності даних, повертається код HTTP 204 “No Content”.

#### Структура об’єкту підсумків зміни

/// \<summary\>

/// Підсумки по зміні

/// \</summary\>

public class ShiftTotals {

/// \<summary\>

/// Підсумки реалізації

/// \</summary\>

public ShiftTotalsOrderType Real { get; set; }

/// \<summary\>

/// Підсумки повернення

/// \</summary\>

public ShiftTotalsOrderType Ret { get; set; }

/// \<summary\>

/// Підсумки видачі готівки

/// \</summary\>

public ShiftTotalsCash Cash { get; set; }

/// \<summary\>

/// Службовий внесок

/// \</summary\>

public double ServiceInput { get; set; }

/// \<summary\>

/// Службова видача

/// \</summary\>

public double ServiceOutput { get; set; }

}

/// \<summary\>

/// Підсумки по типу чека

/// \</summary\>

public class ShiftTotalsOrderType {

/// \<summary\>

/// Загальна сума

/// \</summary\>

public double Sum { get; set; }

/// \<summary\>

/// Загальна сума комісії від переказів

/// \</summary\>

public double TotalCurrencyCommission { get; set; }

/// \<summary\>

/// Кількість чеків

/// \</summary\>

public int OrdersCount { get; set; }

/// \<summary\>

/// Кількість операції переказу коштів

/// \</summary\>

public int TotalCurrencyCost { get; set; }

/// \<summary\>

/// Підсумки по формам оплати

/// \</summary\>

public List\<ShiftTotalsPayForm\> PayForm { get; set; }

/// \<summary\>

/// Податки/збори

/// \</summary\>

public List\<ShiftTotalsTax\> Tax { get; set; }

}

/// \<summary\>

/// Підсумки по формам оплати

/// \</summary\>

public class ShiftTotalsPayForm {

public string PayFormCode { get; set; }

public string PayFormName { get; set; }

public double Sum { get; set; }

}

/// \<summary\>

/// Податки/збори

/// \</summary\>

public class ShiftTotalsTax {

public int Type { get; set; }

public string Name { get; set; }

public string Letter { get; set; }

public double Prc { get; set; }

public bool Sign { get; set; }

public double Turnover { get; set; }

public double Sum { get; set; }

}

/// \<summary\>

/// Підсумки видачі готівки

/// \</summary\>

public class ShiftTotalsCash {

/// \<summary\>

/// Загальна сума

/// \</summary\>

public double Sum { get; set; }

/// \<summary\>

/// Загальна сума комісії

/// \</summary\>

public double Commission { get; set; }

/// \<summary\>

/// Кількість чеків

/// \</summary\>

public int OrdersCount { get; set; }

}

### Запит відомостей про документ за локальним номером

Запит повинен містити JSON, підписаний КЕП користувача.

Формат JSON запиту:

{

“Command”**:** “DocumentInfoByLocalNum”**,**

“NumFiscal”**:** “\<Фіскальний номер ПРРО\>”,

“NumLocal”**:** “\<Локальний номер документа\>”

}

Формат JSON відповіді:

{

NumFiscal = \<Фіскальний номер документа\>,

DocClass = \<Клас документа (“**Check**”, “**ZRep**”)\>,

CheckDocType = \<Тип чека (“**SaleGoods**”, …)\>,

Revoked = \<Ознака відкликаного документа\>,

Storned = \<Ознака сторнованого документа\>

}

У разі відсутності даних, повертається код HTTP 204 “No Content”.

## Видаткові чеки (повернення)

Видаткові чеки (\<DOCTYPE\>0\</DOCTYPE\>, \<DOCSUBTYPE\>1\</DOCSUBTYPE\>,
\<ORDERRETNUM\>Фіскальний номер чека, для якого здійснюється
повернення\</ORDERRETNUM\>) можуть реєструватись тільки в режимі онлайн.

## Сторнування попереднього чека

Чеки сторнування (\<DOCTYPE\>0\</DOCTYPE\>, \<DOCSUBTYPE\>5\</DOCSUBTYPE\>,
\<ORDERSTORNUM\>Фіскальний номер чека, для якого здійснюється
сторнування\</ORDERSTORNUM\>) можуть реєструватись в режимі онлайн або офлайн.

## Порядок засвідчення повідомлень кваліфікованим електронним підписом

Повідомлення повинне бути засвідчене кваліфікованим електронним підписом, згідно
Вимог до формату підписаних даних, затверджених Наказом Наказ Міністерства
юстиції України, Адміністрації Державної служби спеціального зв’язку та захисту
інформації України, від 20.08.2012 № 1236/5/453 (див.
<https://zakon.rada.gov.ua/laws/show/z1401-12>).

Алгоритм підпису - ДСТУ 4145-2002.

Формат підписаних даних - "Базовий ЕЦП" (CAdES Basic Electronic Signature -
CAdES-BES) відповідно до Вимог до формату підписаних даних, затверджених наказом
Міністерства юстиції України та Адміністрації Державної служби спеціального
зв'язку та захисту інформації України № 1236/5/453 від 20.08.2012 р.

Дані, що підписані, зберігаються всередині підписаного повідомлення (поле
"eContent" підписаного повідомлення повинно бути присутнім та містити дані, що
були підписані).

# Адреса фіскального сервера

<http://80.91.165.208:8609/fs>
